<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Portal ‚Äî ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f6fbff;--card:#fff;--mut:#64748b;--border:#e6eef5;--accent:#0ea5a5;--accent2:#60a5fa}
  body{font-family:"Prompt",sans-serif;background:var(--bg);margin:0;color:#0f172a}
  header{padding:16px;background:linear-gradient(180deg,#f0fbff,#eaf7ff);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:18px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 8px 28px rgba(10,30,60,.06)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{padding:10px;border-radius:10px;border:1px solid var(--border);font-size:14px;background:#fff}
  .btn{cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;font-weight:700}
  .btn-ghost{background:#fff;border:1px solid #d6eef3;color:#0b6b6b}
  .small{font-size:13px;color:var(--mut)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  th{background:linear-gradient(180deg,#f7fbff,#f2f8ff);position:sticky;top:0;z-index:1}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
  .modal-box{background:#fff;padding:16px;border-radius:12px;width:820px;max-width:96%}
  td.editable{cursor:text}
  td.editing{background:#fffbe6}
  tbody tr { transition: background-color 0.15s ease; }
  tbody tr:hover { background-color: #e0f2fe; cursor: pointer; }
  tr.st-done { background-color: #d1fae5 !important; }
  tr.st-process { background-color: #ffedd5 !important; }
  tr.st-change { background-color: #cffafe !important; }
  .btn.small { font-size: 13px !important; padding: 4px 8px !important; }
</style>
</head>
<body>
<header>
  <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px">
    <div style="font-weight:700">Admin Portal ‚Äî ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
    <div style="flex:1"></div>
    <div id="userEmail" class="small" style="margin-right:10px;color:#0891b2"></div>
    <button id="signOutBtn" class="btn btn-ghost">Sign out</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <label><strong>1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</strong></label>
    <div class="row">
      <select id="companySelect" style="min-width:260px"><option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option></select>
      <div style="flex:1"></div>
      <input id="cust_code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô RG-1234" style="min-width:220px">
      <button id="setCodeBtn" class="btn btn-primary">‡∏ï‡∏±‡πâ‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
      <button id="copyCodeBtn" class="btn btn-ghost">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</button>
    </div>
    <div id="msg" class="small" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <label><strong>2. ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</strong></label>
    <div class="row">
      <button id="tplBtn" class="btn btn-ghost">‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</button>
      <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none">
      <button id="chooseFileBtn" class="btn btn-ghost">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</button>
      <button id="previewBtn" class="btn btn-ghost">Preview</button>
      <button id="impBtn" class="btn btn-primary">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (Import)</button>
      <button id="expBtn" class="btn btn-ghost">Export</button>
      <label style="margin-left:8px"><input type="checkbox" id="replaceMode"> ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
    </div>
    <div id="previewArea" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <label><strong>3. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (Manual)</strong></label>
    <div class="row" style="align-items:center">
      <input id="trade_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤">
      <input id="common_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç">
      <input id="importer" placeholder="‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤">
      <input id="manufacturer_source" placeholder="‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï">
      <input id="result_phase1" placeholder="‡∏ú‡∏•‡πÄ‡∏ü‡∏™1">
      <input id="analysis_result" placeholder="‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå">
      <input id="plan_trial" placeholder="‡πÅ‡∏ú‡∏ô/‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á">
      <input id="result_phase3" placeholder="‡∏ú‡∏•‡πÄ‡∏ü‡∏™3">
      <input id="note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" style="min-width:200px">
      <button id="addBtn" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>
  </div>

  <div class="card"> 
    <div class="row" style="margin-bottom:8px">
      <input id="adminSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." style="min-width:360px">
      <button id="adminClearBtn" class="btn btn-ghost">‡∏•‡πâ‡∏≤‡∏á</button>
      <div style="flex:1"></div>
      <div id="adminCount" class="small"></div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button id="btnSelectAllFiltered" class="btn btn-ghost small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button id="btnClearSel" class="btn btn-ghost small">‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      <button id="btnDeleteSel" class="btn btn-danger small" style="color:red;border-color:red">‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      <div style="flex:1"></div>
      <button id="btnNotePage" class="btn btn-ghost small">‡∏î‡∏π‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</button>
    </div>
    <div style="overflow-y: auto; max-height: 64vh;"> 
      <table>
        <thead>
          <tr>
            <th style="width:36px"><input id="chkAllVisible" type="checkbox"></th>
            <th>#</th>
            <th>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç</th>
            <th>‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</th>
            <th>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï</th>
            <th>‡∏ú‡∏•‡πÄ‡∏ü‡∏™1</th>
            <th>‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</th>
            <th>‡πÅ‡∏ú‡∏ô/‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á</th>
            <th>‡∏ú‡∏•‡πÄ‡∏ü‡∏™3</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="14" class="small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<div id="noteModal" class="modal"><div class="modal-box"><div style="display:flex;justify-content:space-between;align-items:center">
  <strong>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</strong><button id="closeNote" class="btn btn-ghost">‡∏õ‡∏¥‡∏î</button></div>
  <textarea id="noteText" style="width:100%;min-height:140px;margin-top:8px"></textarea>
  <div style="display:flex;justify-content:flex-end;margin-top:8px"><button id="saveNote" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
</div></div>

<script>
// ================= CONFIG =================
const SUPABASE_URL = 'https://vyfjqpwmvjborjrrtpne.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5ZmpxcHdtdmpib3JqcnJ0cG5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMTI4NjcsImV4cCI6MjA3OTg4ODg2N30.pu9ItBYuuQbH53lJmUzPCU2MW67RvCHr2rzhk3UQUw4';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const COMPANIES_TABLE = 'companies';
const REG_TABLE = 'product_regs';

const $ = id => document.getElementById(id);
let currentCompany = '';
let cachedRows = [];
let filteredRows = [];
const selectedIds = new Set();
let editingNoteId = null;

function esc(s){ return String(s||'').replace(/[&<>'\"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\\' : '&#39;', '"':'&quot;'}[m]) ); }
function toast(m, ok=true){ $('msg').textContent = m; $('msg').style.color = ok ? '#065f46' : '#b91c1c'; setTimeout(()=>{$('msg').textContent='';}, 3500); }

// ================= LOAD & LOGIN =================
document.addEventListener('DOMContentLoaded', async ()=>{
  const { data: { session } } = await sb.auth.getSession();
  if(!session){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
    window.location.href = 'login.html'; 
    return;
  }
  $('userEmail').textContent = session.user.email;
  loadCompanies();
});

async function loadCompanies(){
  const sel = $('companySelect');
  sel.innerHTML = `<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>`;
  try{
    const { data, error } = await sb.from(COMPANIES_TABLE).select('code,name').order('code');
    if(error) throw error;
    sel.innerHTML = `<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option>` + (data||[]).map(c=>`<option value="${esc(c.code)}">${esc(c.code)}${c.name? ' - '+esc(c.name):''}</option>`).join('');
  }catch(e){ 
    console.error(e); 
    sel.innerHTML = `<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</option>`;
  }
}

$('companySelect').addEventListener('change', e=> { if(e.target.value) loadDocs(e.target.value); });

async function loadDocs(code){
  currentCompany = code;
  selectedIds.clear();
  if(!code){ $('tbody').innerHTML = `<tr><td colspan="14" class="small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</td></tr>`; $('adminCount').textContent=''; return; }
  $('tbody').innerHTML = `<tr><td colspan="14" class="small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>`;
  try{
    const { data, error } = await sb.from(REG_TABLE).select('*').eq('company_code', code).order('id',{ascending:true});
    if(error) throw error;
    cachedRows = (data||[]);
    filteredRows = [...cachedRows];
    renderTable();
  }catch(e){ 
    console.error(e); 
    $('tbody').innerHTML = `<tr><td colspan="14" class="small" style="color:red">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${esc(e.message)}</td></tr>`; 
  }
}

function renderTable(q=''){
  const tb = $('tbody');
  if(!filteredRows.length){ tb.innerHTML = `<tr><td colspan="14" class="small">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`; $('adminCount').textContent = ''; return; }
  tb.innerHTML = filteredRows.map((r,i) => {
    let statusClass = '';
    if (r.renewed_status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') statusClass = 'st-done';
    else if (r.renewed_status === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') statusClass = 'st-process';
    else if (r.renewed_status === '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà') statusClass = 'st-change';
    return `
    <tr class="${statusClass}">
      <td><input type="checkbox" class="rowchk" data-id="${esc(r.id)}" ${selectedIds.has(r.id)?'checked':''}></td>
      <td>${i+1}</td>
      <td>${esc(r.company_code||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="trade_name">${esc(r.trade_name||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="common_name">${esc(r.common_name||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="importer">${esc(r.importer||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="manufacturer_source">${esc(r.manufacturer_source||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="result_phase1">${esc(r.result_phase1||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="analysis_result">${esc(r.analysis_result||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="plan_trial">${esc(r.plan_trial||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="result_phase3">${esc(r.result_phase3||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="note">${esc(r.note||'')}</td>
      <td>${esc(r.renewed_status||'')}</td>
      <td style="white-space:nowrap">
         <button class="btn btn-ghost small" onclick="openNote('${esc(r.id)}')">üìù</button>
         <button class="btn btn-primary small" onclick="setStatus('${esc(r.id)}','‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß')">‚úÖ</button>
         <button class="btn btn-ghost small" onclick="setStatus('${esc(r.id)}','‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')">‚è≥</button>
         <button class="btn btn-ghost small" onclick="delDoc('${esc(r.id)}')">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
  
  document.querySelectorAll('.rowchk').forEach(chk=>{
    chk.addEventListener('change', (e)=>{
      const id = e.target.dataset.id;
      if(e.target.checked) selectedIds.add(id); else selectedIds.delete(id);
      updateCount();
    });
  });
  updateCount();
}
function updateCount(){ $('adminCount').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${selectedIds.size} / ‡πÅ‡∏™‡∏î‡∏á ${filteredRows.length} / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${cachedRows.length}`; }

$('chkAllVisible').addEventListener('change', (e)=>{
  const isChecked = e.target.checked;
  document.querySelectorAll('.rowchk').forEach(chk => {
    chk.checked = isChecked;
    if(isChecked) selectedIds.add(chk.dataset.id); else selectedIds.delete(chk.dataset.id);
  });
  updateCount();
});

// ================= EXCEL LOGIC (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤) =================
$('tplBtn').addEventListener('click', ()=>{
  const headers = ['trade_name','common_name','importer','manufacturer_source','result_phase1','analysis_result','plan_trial','result_phase3','note'];
  const example = ['‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤','‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï X','‡∏ú‡πà‡∏≤‡∏ô','‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏±‡πâ‡∏ô','‡∏ó‡∏î‡∏•‡∏≠‡∏á/‡πÅ‡∏ú‡∏ô','‡∏ú‡∏•‡πÄ‡∏ü‡∏™3','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á'];
  const ws = XLSX.utils.aoa_to_sheet([headers, example]);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'template');
  XLSX.writeFile(wb, 'template_registrations.xlsx');
});

$('chooseFileBtn').addEventListener('click', ()=> $('fileInput').click());
$('fileInput').addEventListener('change', ()=> $('previewBtn').click());

$('previewBtn').addEventListener('click', async ()=>{
  const f = $('fileInput').files[0]; if(!f) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô');
  try{
    const ab = await f.arrayBuffer();
    const wb = XLSX.read(ab, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' }); 
    const table = document.createElement('table'); table.style.width='100%'; table.border=1;
    rows.slice(0,10).forEach((r)=>{ const tr = table.insertRow(); r.forEach(c=>{ const td = tr.insertCell(); td.textContent = c; }); });
    const pa = $('previewArea'); pa.innerHTML=''; pa.appendChild(table);
    pa.insertAdjacentHTML('afterbegin', `<div class="small">Preview 10 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å</div>`);
  }catch(e){ alert('Preview ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+e.message); }
});

function pick(obj, keys){ if(!obj) return ''; for(const k of keys){ const sk = k.toLowerCase().trim(); for(const raw in obj){ if(raw.toLowerCase().trim()===sk) return obj[raw]; } } return ''; }

$('impBtn').addEventListener('click', async ()=>{
  const f = $('fileInput').files[0];
  if(!f) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô');
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô');
  if($('replaceMode').checked && !confirm('‚ö†Ô∏è ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡∏µ‡πâ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?')) return;
  
  try{
    const ab = await f.arrayBuffer();
    const wb = XLSX.read(ab, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
    
    const mapped = rows.map(r=>{
      return {
        company_code: currentCompany,
        trade_name: String(pick(r,['trade_name','‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤'])||'').trim(),
        common_name: String(pick(r,['common_name','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç'])||'').trim(),
        importer: String(pick(r,['importer','‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤'])||'').trim()||null,
        manufacturer_source: String(pick(r,['manufacturer_source','‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï','‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï'])||'').trim()||null,
        result_phase1: String(pick(r,['result_phase1','‡∏ú‡∏•‡πÄ‡∏ü‡∏™1'])||'').trim()||null,
        analysis_result: String(pick(r,['analysis_result','‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå'])||'').trim()||null,
        plan_trial: String(pick(r,['plan_trial','‡πÅ‡∏ú‡∏ô/‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á'])||'').trim()||null,
        result_phase3: String(pick(r,['result_phase3','‡∏ú‡∏•‡πÄ‡∏ü‡∏™3'])||'').trim()||null,
        note: String(pick(r,['note','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'])||'').trim()||null
      };
    }).filter(x=> x.trade_name && x.common_name);

    if(mapped.length===0) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç)');
    
    // Replace Logic
    if($('replaceMode').checked){ 
       const del = await sb.from(REG_TABLE).delete().eq('company_code', currentCompany); 
       if(del.error) throw del.error;
    }
    
    // Batch Insert (500 rows/batch)
    let count=0; 
    for(let i=0; i<mapped.length; i+=500){ 
       const chunk = mapped.slice(i,i+500); 
       const { error } = await sb.from(REG_TABLE).insert(chunk); 
       if(error) throw error; 
       count += chunk.length; 
    }
    
    toast(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    loadDocs(currentCompany);
    $('fileInput').value = '';
    $('previewArea').innerHTML = '';
  }catch(err){ alert('Import Error: '+err.message); }
});

$('expBtn').addEventListener('click', ()=>{
  if(!currentCompany || !cachedRows.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
  const aoa = [['‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó','‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç','‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤','‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï','‡∏ú‡∏•‡πÄ‡∏ü‡∏™1','‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå','‡πÅ‡∏ú‡∏ô/‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á','‡∏ú‡∏•‡πÄ‡∏ü‡∏™3','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']];
  cachedRows.forEach(r=> aoa.push([r.company_code, r.trade_name, r.common_name, r.importer, r.manufacturer_source, r.result_phase1, r.analysis_result, r.plan_trial, r.result_phase3, r.note, r.renewed_status]));
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Export');
  XLSX.writeFile(wb, `export_${currentCompany}.xlsx`);
});

// ================= CUSTOMER CODE & SEARCH =================
$('setCodeBtn').addEventListener('click', async ()=>{
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó');
  const code = $('cust_code').value.trim(); if(!code) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™');
  const { error } = await sb.from(COMPANIES_TABLE).upsert({ code: currentCompany, plain_code: code }, { onConflict: 'code' });
  if(!error){ toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß'); loadCompanies(); } else alert(error.message);
});
$('copyCodeBtn').addEventListener('click', async ()=>{ 
  const code = $('cust_code').value.trim(); 
  if(code) { await navigator.clipboard.writeText(code); alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'); } 
  else alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™'); 
});

$('adminSearch').addEventListener('input', ()=>{
  const q = $('adminSearch').value.trim().toLowerCase();
  if(!q) { filteredRows = [...cachedRows]; }
  else {
     const toks = q.split(/\s+/).filter(Boolean);
     filteredRows = cachedRows.filter(r=>{
        const hay = [r.trade_name,r.common_name,r.importer,r.manufacturer_source,r.note].join(' ').toLowerCase();
        return toks.every(t => hay.includes(t));
     });
  }
  renderTable();
});
$('adminClearBtn').addEventListener('click', ()=>{ $('adminSearch').value=''; filteredRows=[...cachedRows]; renderTable(); });

$('btnSelectAllFiltered').addEventListener('click', ()=> filteredRows.forEach(r=> selectedIds.add(r.id)) || updateCount() || renderTable());
$('btnClearSel').addEventListener('click', ()=> selectedIds.clear() || updateCount() || renderTable());
$('btnDeleteSel').addEventListener('click', async ()=>{
  if(!selectedIds.size) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô');
  if(confirm(`‡∏•‡∏ö ${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)){
     const { error } = await sb.from(REG_TABLE).delete().in('id', Array.from(selectedIds));
     if(!error){ selectedIds.clear(); loadDocs(currentCompany); } else alert(error.message);
  }
});

// ================= OTHER ACTIONS =================
$('addBtn').addEventListener('click', async()=>{
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó');
  const payload = {
    company_code: currentCompany,
    trade_name: $('trade_name').value.trim(),
    common_name: $('common_name').value.trim(),
    importer: $('importer').value.trim()||null,
    manufacturer_source: $('manufacturer_source').value.trim()||null,
    result_phase1: $('result_phase1').value.trim()||null,
    analysis_result: $('analysis_result').value.trim()||null,
    plan_trial: $('plan_trial').value.trim()||null,
    result_phase3: $('result_phase3').value.trim()||null,
    note: $('note').value.trim()||null
  };
  if(!payload.trade_name) return alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤');
  const {error} = await sb.from(REG_TABLE).insert(payload);
  if(!error){ 
     document.querySelectorAll('input').forEach(i=>{ if(i.id!=='adminSearch' && i.id!=='cust_code') i.value=''; });
     loadDocs(currentCompany); 
  } else alert(error.message);
});

$('btnNotePage').addEventListener('click', ()=>{
  filteredRows = cachedRows.filter(r => r.note && r.note.trim() !== '');
  renderTable();
  $('adminSearch').value = '[‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏]';
});

// Inline & Modal actions
window.openNote = (id)=>{ editingNoteId=id; const r=cachedRows.find(x=>x.id==id); $('noteText').value=r?.note||''; $('noteModal').style.display='flex'; };
$('closeNote').addEventListener('click', ()=>$('noteModal').style.display='none');
$('saveNote').addEventListener('click', async()=>{
  if(!editingNoteId) return;
  const {error} = await sb.from(REG_TABLE).update({note:$('noteText').value}).eq('id',editingNoteId);
  if(!error){ $('noteModal').style.display='none'; loadDocs(currentCompany); } else alert(error.message);
});

window.setStatus = async (id, st)=>{ const {error}=await sb.from(REG_TABLE).update({renewed_status:st}).eq('id',id); if(!error) loadDocs(currentCompany); else alert(error.message); };
window.delDoc = async (id)=>{ if(confirm('‡∏•‡∏ö?')){ const {error}=await sb.from(REG_TABLE).delete().eq('id',id); if(!error) loadDocs(currentCompany); else alert(error.message); } };

$('tbody').addEventListener('dblclick', (e)=>{
  const td = e.target.closest('td.editable');
  if(!td || td.classList.contains('editing')) return;
  td.classList.add('editing');
  const id = td.dataset.id;
  const field = td.dataset.field;
  const old = td.textContent.trim();
  const input = document.createElement('input');
  input.style.width = '100%'; input.value = old;
  td.innerHTML = ''; td.appendChild(input); input.focus();
  const finish = async ()=>{
     td.classList.remove('editing');
     const newVal = input.value.trim();
     if(newVal === old) { td.innerHTML = esc(old); return; }
     try{
       const payload={}; payload[field]=newVal||null;
       const {error}=await sb.from(REG_TABLE).update(payload).eq('id', id);
       if(error) throw error;
       loadDocs(currentCompany);
     }catch(e){ alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+e.message); td.innerHTML = esc(old); }
  };
  input.addEventListener('keydown', ev=>{ if(ev.key==='Enter') finish(); if(ev.key==='Escape'){td.innerHTML=esc(old); td.classList.remove('editing');} });
  input.addEventListener('blur', finish);
});

$('signOutBtn').addEventListener('click', async()=>{ await sb.auth.signOut(); window.location.href='login.html'; });

</script>
</body>
</html>
