<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Portal ‚Äî ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)</title>

<!-- Supabase JS (ESM) -->
<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
<!-- SheetJS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f6fbff;--card:#fff;--mut:#64748b;--border:#e6eef5;--accent:#0ea5a5;--accent2:#60a5fa}
  body{font-family:"Prompt",sans-serif;background:var(--bg);margin:0;color:#0f172a}
  header{padding:16px;background:linear-gradient(180deg,#f0fbff,#eaf7ff);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:18px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 8px 28px rgba(10,30,60,.06)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{padding:10px;border-radius:10px;border:1px solid var(--border);font-size:14px;background:#fff}
  .btn{cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;font-weight:700}
  .btn-ghost{background:#fff;border:1px solid #d6eef3;color:#0b6b6b}
  .small{font-size:13px;color:var(--mut)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  th{background:linear-gradient(180deg,#f7fbff,#f2f8ff);position:sticky;top:0;z-index:1}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
  .modal-box{background:#fff;padding:16px;border-radius:12px;width:820px;max-width:96%}
  td.editable{cursor:text}
  td.editing{background:#fffbe6}
  .badge{padding:6px 8px;border-radius:999px;font-weight:600;font-size:13px}
  .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d090}
  .warn{background:#fff7ed;color:#b45309;border:1px solid #fde68a80}
  .exp{background:#fff1f2;color:#b91c1c;border:1px solid #fecaca90}
  tbody tr { transition: background-color 0.15s ease; }
  tbody tr:hover { background-color: #e0f2fe; cursor: pointer; }
  tbody tr:hover td.editing { background-color: #fffbe6; cursor: text; }
  tr.st-done { background-color: #d1fae5 !important; }
  tr.st-process { background-color: #ffedd5 !important; }
  tr.st-change { background-color: #cffafe !important; }
  tr.st-done:hover { background-color: #a7f3d0 !important; }
  tr.st-process:hover { background-color: #fed7aa !important; }
  .badge { font-size: 13px !important; padding: 4px 8px !important; white-space: nowrap; vertical-align: middle; border-radius: 6px; font-weight: 600; border: 1px solid transparent; }
  .change { color: #9d174d !important; background: #fce7f3 !important; border: 1px solid #f472b6 !important; }
  .btn.small, .btn-ghost.small { font-size: 13px !important; padding: 4px 8px !important; height: auto; }
</style>
</head>
<body>
<header>
  <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px">
    <div style="font-weight:700">Admin Portal ‚Äî ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
    <div style="flex:1"></div>
    <button id="signOutBtn" class="btn btn-ghost">Sign out</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <label><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</strong></label>
    <div class="row">
      <select id="companySelect" style="min-width:260px"><option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option></select>
      <div style="flex:1"></div>
      <input id="cust_code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô RG-1234" style="min-width:220px">
      <button id="setCodeBtn" class="btn btn-primary">‡∏ï‡∏±‡πâ‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
      <button id="copyCodeBtn" class="btn btn-ghost">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</button>
    </div>
    <div id="msg" class="small" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <label><strong>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å (Preview + Proxy)</strong></label>
    <div class="row">
      <button id="tplBtn" class="btn btn-ghost">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï (.xlsx)</button>
      <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none">
      <button id="chooseFileBtn" class="btn btn-ghost">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
      <button id="previewBtn" class="btn btn-ghost">Preview</button>
      <button id="impBtn" class="btn btn-primary">Import to Server</button>
      <button id="expBtn" class="btn btn-ghost">Export Excel</button>
      <label style="margin-left:8px"><input type="checkbox" id="replaceMode"> ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡∏µ‡πâ</label>
    </div>
    <div id="previewArea" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <label><strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏î‡πà‡∏ß‡∏ô)</strong></label>
    <div class="row" style="align-items:center">
      <input id="trade_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤">
      <input id="common_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç">
      <input id="importer" placeholder="‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤">
      <input id="manufacturer_source" placeholder="‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï">
      <input id="result_phase1" placeholder="‡∏ú‡∏•‡πÄ‡∏ü‡∏™1">
      <input id="analysis_result" placeholder="‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå">
      <input id="plan_trial" placeholder="‡πÅ‡∏ú‡∏ô/‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á">
      <input id="result_phase3" placeholder="‡∏ú‡∏•‡πÄ‡∏ü‡∏™3">
      <input id="note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" style="min-width:200px">
      <button id="addBtn" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>
    <div class="small" style="margin-top:8px">* double-click ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö inline</div>
  </div>

  <div class="card"> 
  <div class="row" style="margin-bottom:8px">
    <input id="adminSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç / ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ / ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï ..." style="min-width:360px">
    <button id="adminClearBtn" class="btn btn-ghost">‡∏•‡πâ‡∏≤‡∏á</button>
    <div style="flex:1"></div>
    <div id="adminCount" class="small"></div>
  </div>

  <div style="display:flex;gap:8px;margin-bottom:8px">
    <button id="btnSelectAllFiltered" class="btn btn-ghost small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ú‡∏•‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</button>
    <button id="btnClearSel" class="btn btn-ghost small">‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    <button id="btnDeleteSel" class="btn btn-danger small">‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    <div style="flex:1"></div>
    <button id="btnNotePage" class="btn btn-ghost small">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>

  <div style="overflow-y: auto; max-height: 64vh;"> <table>
      <thead>
        <tr>
          <th style="width:36px"><input id="chkAllVisible" type="checkbox"></th>
          <th>#</th>
          <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç</th>
          <th>‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</th>
          <th>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï</th>
          <th>‡∏ú‡∏•‡πÄ‡∏ü‡∏™1</th>
          <th>‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</th>
          <th>‡πÅ‡∏ú‡∏ô/‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á</th>
          <th>‡∏ú‡∏•‡πÄ‡∏ü‡∏™3</th>
          <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="14" class="small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</td></tr></tbody>
    </table>
  </div>
</div>

<!-- note modal -->
<div id="noteModal" class="modal"><div class="modal-box"><div style="display:flex;justify-content:space-between;align-items:center">
  <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</strong><button id="closeNote" class="btn btn-ghost">‡∏õ‡∏¥‡∏î</button></div>
  <textarea id="noteText" style="width:100%;min-height:140px;margin-top:8px"></textarea>
  <div style="display:flex;justify-content:flex-end;margin-top:8px"><button id="saveNote" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
</div></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// ================= CONFIG (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) =================
const SUPABASE_URL = 'https://vyfjqpwmvjborjrrtpne.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5ZmpxcHdtdmpib3JqcnJ0cG5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMTI4NjcsImV4cCI6MjA3OTg4ODg2N30.pu9ItBYuuQbH53lJmUzPCU2MW67RvCHr2rzhk3UQUw4';

const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡πÉ‡∏´‡πâ Checkbox ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
$('chkAllVisible').addEventListener('change', (e)=>{
  const isChecked = e.target.checked;
  // 1. ‡∏ï‡∏¥‡πä‡∏Å‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
  document.querySelectorAll('.rowchk').forEach(chk => {
    chk.checked = isChecked;
    const id = chk.dataset.id;
    if(isChecked) selectedIds.add(id); else selectedIds.delete(id);
  });
  // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  $('adminCount').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${selectedIds.size} / ‡πÅ‡∏™‡∏î‡∏á ${filteredRows.length} / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${cachedRows.length}`;
});

// table names
const COMPANIES_TABLE = 'companies';
const REG_TABLE = 'product_regs';

const $ = id => document.getElementById(id);
let currentCompany = '';
let cachedRows = [];
let filteredRows = [];
const selectedIds = new Set();
let editingNoteId = null;
function esc(s){ return String(s||'').replace(/[&<>'\"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\\' : '&#39;', '"':'&quot;'}[m]) ); }
function toast(m, ok=true){ $('msg').textContent = m; $('msg').style.color = ok ? '#065f46' : '#b91c1c'; setTimeout(()=>{$('msg').textContent='';}, 3500); }

async function loadCompanies(){
  const sel = $('companySelect');
  sel.innerHTML = `<option value="">‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option>`;
  try{
    const { data, error } = await sb.from(COMPANIES_TABLE).select('code,name').order('code',{ascending:true});
    if(error) throw error;
    const rows = data || [];
    sel.innerHTML = `<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option>` + rows.map(c=>`<option value="${esc(c.code)}">${esc(c.code)}${c.name? ' - '+esc(c.name):''}</option>`).join('');
  }catch(e){ console.error(e); sel.innerHTML = `<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>`; }
}

async function loadDocs(code){
  currentCompany = code;
  selectedIds.clear();
  if(!code){ $('tbody').innerHTML = `<tr><td colspan="14" class="small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</td></tr>`; $('adminCount').textContent=''; return; }
  try{
    const { data, error } = await sb.from(REG_TABLE).select('*').eq('company_code', code).order('id',{ascending:true});
    if(error) throw error;
    cachedRows = (data||[]);
    filteredRows = [...cachedRows];
    renderTable();
  }catch(e){ console.error(e); $('tbody').innerHTML = `<tr><td colspan="14" class="small">${esc(e.message)}</td></tr>`; }
}

function renderTable(q=''){
  const tb = $('tbody');
  if(!filteredRows.length){ tb.innerHTML = `<tr><td colspan="14" class="small">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`; $('adminCount').textContent = ''; return; }
  tb.innerHTML = filteredRows.map((r,i) => {
    let statusClass = '';
    if (r.renewed_status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') statusClass = 'st-done';
    else if (r.renewed_status === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') statusClass = 'st-process';
    else if (r.renewed_status === '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà') statusClass = 'st-change';

    return `
    <tr class="${statusClass}">
      <td><input type="checkbox" class="rowchk" data-id="${esc(r.id)}" ${selectedIds.has(r.id)?'checked':''}></td>
      <td>${i+1}</td>
      <td>${esc(r.company_code||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="trade_name">${esc(r.trade_name||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="common_name">${esc(r.common_name||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="importer">${esc(r.importer||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="manufacturer_source">${esc(r.manufacturer_source||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="result_phase1">${esc(r.result_phase1||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="analysis_result">${esc(r.analysis_result||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="plan_trial">${esc(r.plan_trial||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="result_phase3">${esc(r.result_phase3||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="note">${esc(r.note||'')}</td>
      <td><div style="font-size:12px; color:#555; margin-top:2px;">${esc(r.renewed_status||'')}</div></td>
      <td style="white-space:nowrap">
        <div style="display:flex; flex-direction:column; gap:4px;">
           <div style="display:flex; align-items:center; gap:2px;">
              <button class="btn btn-ghost small" style="padding:4px 8px;" onclick="openNote('${esc(r.id)}')">üìù ‡∏à‡∏î‡πÇ‡∏ô‡πâ‡∏ï</button>
              ${ r.note ? `<button class="btn btn-ghost small" style="padding:4px 6px; color:red; font-size:12px;" onclick="clearNote('${esc(r.id)}')" title="‡∏•‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏">x</button>` : '' }
           </div>
           <div style="display:flex; align-items:center; gap:2px;">
              <button class="btn btn-ghost small" style="padding:4px;" title="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" onclick="setStatus('${esc(r.id)}','‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')">‚è≥</button>
              <button class="btn btn-primary small" style="padding:4px;" title="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß" onclick="setStatus('${esc(r.id)}','‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß')">‚úÖ</button>
              <button class="btn btn-ghost small" style="padding:4px; color:#0891b2;" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà" onclick="setStatus('${esc(r.id)}','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà')">üè≠</button>
              <span style="border-left:1px solid #ddd; margin:0 4px; height:16px;"></span>
              <button class="btn btn-ghost small" style="padding:4px; color:#f59e0b;" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" onclick="clearStatus('${esc(r.id)}')">üö´</button>
              <button class="btn btn-ghost small" style="padding:4px; color:#b91c1c;" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" onclick="delDoc('${esc(r.id)}')">üóëÔ∏è</button>
           </div>
        </div>
      </td>
    </tr>
  `}).join('');

  document.querySelectorAll('.rowchk').forEach(chk=>{
    chk.addEventListener('change', (e)=>{
      const id = e.target.dataset.id;
      if(e.target.checked) selectedIds.add(id); else selectedIds.delete(id);
      $('adminCount').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${selectedIds.size} / ‡πÅ‡∏™‡∏î‡∏á ${filteredRows.length} / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${cachedRows.length}`;
    });
  });

  $('adminCount').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${selectedIds.size} / ‡πÅ‡∏™‡∏î‡∏á ${filteredRows.length} / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${cachedRows.length}`;
  $('chkAllVisible').checked = filteredRows.length>0 && filteredRows.every(r=>selectedIds.has(r.id));
}

function applyFilter(){
  const q = ($('adminSearch').value||'').trim().toLowerCase();
  if(!q){ filteredRows = [...cachedRows]; renderTable(); return; }
  const toks = q.split(/\s+/).filter(Boolean);
  filteredRows = cachedRows.filter(r=>{
    const hay = [r.trade_name,r.common_name,r.importer,r.manufacturer_source,r.result_phase1,r.analysis_result,r.plan_trial,r.result_phase3,r.note].join(' ').toLowerCase();
    return toks.every(t => hay.includes(t));
  });
  renderTable(q);
}

$('addBtn').addEventListener('click', async ()=>{ 
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô');
  const payload = {
    company_code: currentCompany,
    trade_name: $('trade_name').value.trim(),
    common_name: $('common_name').value.trim(),
    importer: $('importer').value.trim() || null,
    manufacturer_source: $('manufacturer_source').value.trim() || null,
    result_phase1: $('result_phase1').value.trim() || null,
    analysis_result: $('analysis_result').value.trim() || null,
    plan_trial: $('plan_trial').value.trim() || null,
    result_phase3: $('result_phase3').value.trim() || null,
    note: $('note').value.trim() || null
  };
  if(!payload.trade_name || !payload.common_name) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç');
  try{
    const { error } = await sb.from(REG_TABLE).insert(payload);
    if(error) throw error;
    ['trade_name','common_name','importer','manufacturer_source','result_phase1','analysis_result','plan_trial','result_phase3','note'].forEach(id=>{ if($(id)) $(id).value=''; });
    loadDocs(currentCompany);
  }catch(e){ alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

(function initInlineEdit(){
  const tb = $('tbody');
  tb.addEventListener('dblclick', (e)=>{
    const td = e.target.closest('td.editable');
    if(!td) return;
    if(td.classList.contains('editing')) return;
    td.classList.add('editing');
    const id = td.dataset.id;
    const field = td.dataset.field;
    const old = td.textContent.trim();
    const input = document.createElement('input');
    input.style.width = '100%';
    input.value = old;
    td.innerHTML = ''; td.appendChild(input); input.focus();
    const finish = async (commit)=>{
      td.classList.remove('editing');
      if(!commit){ td.innerHTML = esc(old); return; }
      const payload = {}; payload[field] = input.value.trim() || null;
      try{
        const { error } = await sb.from(REG_TABLE).update(payload).eq('id', id);
        if(error) throw error;
        loadDocs(currentCompany);
      }catch(e){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); td.innerHTML = esc(old); }
    };
    input.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ ev.preventDefault(); finish(true);} if(ev.key==='Escape'){ finish(false); }});
    input.addEventListener('blur', ()=> finish(true));
  });
})();

window.openNote = (id)=>{
  editingNoteId = id;
  const row = cachedRows.find(r=>r.id==id);
  $('noteText').value = row?.note || '';
  $('noteModal').style.display = 'flex';
};
$('closeNote').addEventListener('click', ()=> $('noteModal').style.display='none');
$('saveNote').addEventListener('click', async ()=>{
  if(!editingNoteId) return;
  try{
    const { error } = await sb.from(REG_TABLE).update({ note: $('noteText').value }).eq('id', editingNoteId);
    if(error) throw error;
    $('noteModal').style.display='none';
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

window.setStatus = async function(id, statusText){
  try{
    const { error } = await sb.from(REG_TABLE).update({ renewed_status: statusText }).eq('id', id);
    if(error) throw error;
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
};

window.delDoc = async function(id){
  if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  try{
    const { error } = await sb.from(REG_TABLE).delete().eq('id', id);
    if(error) throw error;
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
};

$('btnDeleteSel').addEventListener('click', async ()=>{
  if(selectedIds.size===0) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô');
  if(!confirm(`‡∏•‡∏ö ${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) return;
  try{
    const ids = Array.from(selectedIds).map(x=>Number(x));
    const { error } = await sb.from(REG_TABLE).delete().in('id', ids);
    if(error) throw error;
    selectedIds.clear(); loadDocs(currentCompany);
  }catch(e){ alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

$('setCodeBtn').addEventListener('click', async ()=>{
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó');
  const code = $('cust_code').value.trim(); if(!code) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™');
  try{
    const { error } = await sb.from(COMPANIES_TABLE).upsert({ code: currentCompany, plain_code: code }, { onConflict: 'code' });
    if(error) throw error;
    toast('‡∏ï‡∏±‡πâ‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    loadCompanies();
  }catch(e){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});
$('copyCodeBtn').addEventListener('click', async ()=>{ const code = $('cust_code').value.trim(); if(!code) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™'); await navigator.clipboard.writeText(code); alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'); });

$('tplBtn').addEventListener('click', ()=>{
  const headers = ['trade_name','common_name','importer','manufacturer_source','result_phase1','analysis_result','plan_trial','result_phase3','note'];
  const example = ['‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤','‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï X','‡∏ú‡πà‡∏≤‡∏ô','‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏±‡πâ‡∏ô','‡∏ó‡∏î‡∏•‡∏≠‡∏á/‡πÅ‡∏ú‡∏ô','‡∏ú‡∏•‡πÄ‡∏ü‡∏™3','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á'];
  const aoa = [headers, example];
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'template');
  XLSX.writeFile(wb, 'template_registrations.xlsx');
});

$('chooseFileBtn').addEventListener('click', ()=> $('fileInput').click());
$('previewBtn').addEventListener('click', async ()=>{
  const f = $('fileInput').files[0]; if(!f) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô preview');
  try{
    const ab = await f.arrayBuffer();
    const wb = XLSX.read(ab, { type:'array', raw:true });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' }); 
    const table = document.createElement('table'); table.style.width='100%'; table.border=1;
    rows.slice(0,11).forEach((r)=>{ const tr = table.insertRow(); r.forEach(c=>{ const td = tr.insertCell(); td.textContent = c; }); });
    const pa = $('previewArea'); pa.innerHTML=''; pa.appendChild(table);
    pa.insertAdjacentHTML('afterbegin', `<div class="small">Preview: ‡πÅ‡∏ñ‡∏ß‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡πÅ‡∏ñ‡∏ß ‚Äî ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Å‡∏î Import to Server</div>`);
  }catch(e){ alert('Preview ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

function normalizeDate(v){ return null; } // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠
function pick(obj, keys){ if(!obj) return ''; for(const k of keys){ const sk = k.toLowerCase().trim(); for(const raw in obj){ if(raw.toLowerCase().trim()===sk) return obj[raw]; } } return ''; }

$('impBtn').addEventListener('click', async ()=>{
  const f = $('fileInput').files[0];
  if(!f) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î Import');
  if(!currentCompany) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
  if($('replaceMode').checked && !confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  try{
    const ab = await f.arrayBuffer();
    const wb = XLSX.read(ab, { type:'array', cellDates: true });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
    console.log('Raw Rows from Excel:', rows.slice(0,3));
    const mapped = rows.map(r=>{
      const trade = pick(r,['trade_name','‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤','brand_name','brand']);
      const common = pick(r,['common_name','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£']);
      const importer = pick(r,['importer','‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤']);
      const manu = pick(r,['manufacturer_source','‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï','‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï']);
      const p1 = pick(r,['result_phase1','‡∏ú‡∏•‡πÄ‡∏ü‡∏™1']);
      const analysis = pick(r,['analysis_result','‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå']);
      const plan = pick(r,['plan_trial','‡πÅ‡∏ú‡∏ô/‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á','‡πÅ‡∏ú‡∏ô‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á']);
      const p3 = pick(r,['result_phase3','‡∏ú‡∏•‡πÄ‡∏ü‡∏™3']);
      const note = pick(r,['note','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']);
      return {
        company_code: currentCompany,
        trade_name: String(trade||'').trim(),
        common_name: String(common||'').trim(),
        importer: String(importer||'').trim()||null,
        manufacturer_source: String(manu||'').trim()||null,
        result_phase1: String(p1||'').trim()||null,
        analysis_result: String(analysis||'').trim()||null,
        plan_trial: String(plan||'').trim()||null,
        result_phase3: String(p3||'').trim()||null,
        note: String(note||'').trim()||null
      };
    }).filter(x=> x.trade_name && x.common_name);
    console.log('Mapped:', mapped.slice(0,5));
    if(mapped.length===0) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô Excel');
    if($('replaceMode').checked){ const del = await sb.from(REG_TABLE).delete().eq('company_code', currentCompany); if(del.error) throw new Error('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+del.error.message); }
    let successCount=0; for(let i=0;i<mapped.length;i+=500){ const chunk = mapped.slice(i,i+500); const { error } = await sb.from(REG_TABLE).insert(chunk); if(error) throw error; successCount += chunk.length; }
    toast(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    loadDocs(currentCompany);
    $('fileInput').value = '';
  }catch(err){ console.error('IMPORT ERROR', err); alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+(err.message||err)); }
});

$('expBtn').addEventListener('click', async ()=>{
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
  try{
    const rows = cachedRows || [];
    const aoa = [['‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó','‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç','‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤','‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï','‡∏ú‡∏•‡πÄ‡∏ü‡∏™1','‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå','‡πÅ‡∏ú‡∏ô/‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á','‡∏ú‡∏•‡πÄ‡∏ü‡∏™3','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']];
    rows.forEach(r=> aoa.push([r.company_code||'', r.trade_name||'', r.common_name||'', r.importer||'', r.manufacturer_source||'', r.result_phase1||'', r.analysis_result||'', r.plan_trial||'', r.result_phase3||'', r.note||'', r.renewed_status||'']));
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, currentCompany.slice(0,31)); XLSX.writeFile(wb, `registrations_${currentCompany}.xlsx`);
  }catch(e){ alert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

$('fileInput').addEventListener('change', ()=> $('previewBtn').click());
$('companySelect').addEventListener('change', e=> { if(e.target.value) loadDocs(e.target.value); });
$('adminSearch').addEventListener('input', ()=> applyFilter());
$('adminClearBtn').addEventListener('click', ()=> { $('adminSearch').value=''; applyFilter(); });
$('btnSelectAllFiltered').addEventListener('click', ()=> filteredRows.forEach(r=> selectedIds.add(r.id)) || renderTable());
$('btnClearSel').addEventListener('click', ()=> selectedIds.clear() || renderTable());
$('signOutBtn').addEventListener('click', async ()=> { await sb.auth.signOut(); sessionStorage.removeItem('legacy_admin_key'); location.href = '/admin_login.html'; });

window.clearStatus = async function(id){
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  try{ const { error } = await sb.from(REG_TABLE).update({ renewed_status: null }).eq('id', id); if(error) throw error; loadDocs(currentCompany); }catch(e){ alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
};
window.clearNote = async function(id){ if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" ‡∏ó‡∏¥‡πâ‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return; try{ const { error } = await sb.from(REG_TABLE).update({ note: null }).eq('id', id); if(error) throw error; loadDocs(currentCompany); }catch(e){ alert('‡∏•‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); } };

document.addEventListener('DOMContentLoaded', async ()=>{
  try{ const { data: { session } } = await sb.auth.getSession(); }catch(e){ console.error(e); }
  await loadCompanies();
});

// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ---
$('btnNotePage').addEventListener('click', ()=>{
  // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á note
  filteredRows = cachedRows.filter(r => r.note && r.note.trim() !== '');
  renderTable();
  $('adminSearch').value = '[‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏]'; // ‡πÉ‡∏™‡πà text ‡∏´‡∏•‡∏≠‡∏Å‡πÜ ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà
});
window.openNote = openNote;
window.setStatus = setStatus;
window.delDoc = delDoc;
window.loadDocs = loadDocs;
window.applyFilter = applyFilter;
window.loadCompanies = loadCompanies;

</script>
</body>
</html>
