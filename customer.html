<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Customer Dashboard ‚Äî ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f8fafc;--card:#fff;--text:#334155;--accent:#0ea5a5;--success:#10b981;--warn:#f59e0b;--info:#3b82f6}
  *{box-sizing:border-box}
  body{font-family:"Prompt",sans-serif;background:var(--bg);margin:0;color:var(--text);padding-bottom:60px}
  
  header{background:#fff;padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10}
  .brand{font-weight:700;font-size:18px;color:#0f172a}
  .nav-link{text-decoration:none;color:#64748b;font-size:14px;margin-left:16px;padding:6px 12px;border-radius:6px;transition:0.2s}
  .nav-link:hover, .nav-link.active{background:#f1f5f9;color:#0f172a}

  .wrap{max-width:1000px;margin:24px auto;padding:0 20px}
  
  .search-box{background:#fff;padding:20px;border-radius:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);margin-bottom:24px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input, select{padding:12px;border:1px solid #cbd5e1;border-radius:10px;font-size:15px;outline:none;background:#fff}
  input{flex:1}
  button{padding:12px 20px;background:var(--text);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:0.2s}
  
  .filter-bar { display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
  .filter-bar select { min-width: 240px; border-color:var(--accent); color:var(--accent); font-weight:600; }

  .list-card{background:#fff;border-radius:16px;border:1px solid #e2e8f0;overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.03);}
  table{width:100%;border-collapse:collapse; min-width: 600px;}
  .table-responsive { overflow-x: auto; }
  
  th,td{padding:16px;text-align:left;border-bottom:1px solid #f1f5f9; vertical-align:middle;}
  th{background:#f1f5f9;font-size:14px;color:#475569;font-weight:700}
  tr:last-child td{border-bottom:none}
  
  .mini-progress-track { width: 100%; background: #e2e8f0; height: 10px; border-radius: 6px; overflow: hidden; margin-top: 8px; }
  .mini-progress-fill { height: 100%; background: linear-gradient(90deg, #f59e0b, #fbbf24); border-radius: 6px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
  
  .badge-step { font-size:12px; font-weight:700; padding:4px 8px; border-radius:6px; background:#f1f5f9; color:#64748b; display:inline-block; margin-bottom:4px; }
  .badge-pct { float:right; color:#f59e0b; font-weight:700; font-size:13px; }
</style>
</head>
<body>

<header>
  <div class="brand">Customer Dashboard</div>
  <nav>
    <a href="customer.html" class="nav-link">üìù ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
    <a href="#" class="nav-link active">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</a>
  </nav>
</header>

<div class="wrap">
  <div class="search-box">
    <label style="font-weight:600;white-space:nowrap">‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</label>
    <input id="access_code" placeholder="‡πÄ‡∏ä‡πà‡∏ô TEST999">
    <button id="btnLoad">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </div>

  <div id="contentArea" style="display:none">
    
    <div style="margin-bottom:8px; font-size:18px; font-weight:700;">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)</div>
    
    <div class="filter-bar">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</label>
      <select id="stageFilter">
        <option value="all">üî• ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà)</option>
        <option value="step1">1. ‡∏Ç‡∏±‡πâ‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠ (5-15%)</option>
        <option value="step2">2. ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ü‡∏™ 1 ‡πÅ‡∏•‡πâ‡∏ß (35%)</option>
        <option value="step3">3. ‡∏ú‡πà‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (60%)</option>
        <option value="step4">4. ‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á (75%)</option>
        <option value="step5">5. ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏ü‡∏™ 3 (90%)</option>
      </select>
      <div style="flex:1; text-align:right; font-size:13px; color:#64748b">
        ‡∏û‡∏ö <span id="countFiltered" style="font-weight:700;color:#0f172a">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      </div>
    </div>

    <div class="list-card table-responsive">
      <table>
        <thead>
          <tr>
            <th style="min-width:180px">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
            <th style="min-width:150px">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç</th>
            <th style="min-width:200px">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
            <th style="min-width:140px">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
          </tr>
        </thead>
        <tbody id="mainTbody">
          <tr><td colspan="4" style="text-align:center;padding:30px;color:#94a3b8">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
        </tbody>
      </table>
    </div>

    <div style="margin-top:40px; border-top:1px solid #e2e8f0; padding-top:20px;">
      <div style="font-size:14px; font-weight:700; color:#10b981; margin-bottom:12px;">
        ‚úÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô / ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏ô)
      </div>
      <div style="background:#f8fafc; border-radius:12px; padding:16px; font-size:13px; color:#64748b;" id="historyArea">
        - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -
      </div>
    </div>

  </div>
</div>

<script>
// CONFIG ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ customer.html
const SUPABASE_URL = 'https://vyfjqpwmvjborjrrtpne.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5ZmpxcHdtdmpib3JqcnJ0cG5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMTI4NjcsImV4cCI6MjA3OTg4ODg2N30.pu9ItBYuuQbH53lJmUzPCU2MW67RvCHr2rzhk3UQUw4';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = id => document.getElementById(id);
let globalRows = [];

// *** ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ customer.html ‡πÉ‡∏ä‡πâ ***
const STORAGE_KEY = 'customer_access_code'; 

window.addEventListener('DOMContentLoaded', ()=>{
  const savedCode = localStorage.getItem(STORAGE_KEY) || '';
  if(savedCode){ 
      $('access_code').value = savedCode; 
      loadDashboard(savedCode); 
  }
});

$('btnLoad').addEventListener('click', ()=> loadDashboard($('access_code').value));
$('access_code').addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadDashboard($('access_code').value); });
$('stageFilter').addEventListener('change', ()=> renderTable());

async function loadDashboard(code){
  code = code.trim(); 
  if(!code) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
  
  localStorage.setItem(STORAGE_KEY, code); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
  $('btnLoad').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
  
  try{
    // 1. ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á companies ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ customer.html)
    let searchCode = code;
    
    // ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å companies
    const { data: companies } = await sb.from('companies')
       .select('code')
       .or(`code.eq.${code},plain_code.eq.${code}`)
       .limit(1);

    if(companies && companies.length > 0){
        searchCode = companies[0].code; // ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    }

    // 2. ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    const { data, error } = await sb.from('product_regs').select('*').eq('company_code', searchCode);
    
    if(error) throw error;
    
    if(!data || data.length === 0) {
       alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™: ' + code);
       $('btnLoad').textContent = '‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
       return;
    }
    
    globalRows = data; 
    renderTable(); 
    renderHistory();
    $('contentArea').style.display = 'block';

  }catch(e){ 
    console.error(e); 
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message); 
  }
  finally{ 
    $('btnLoad').textContent = '‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; 
  }
}

// === ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % ===
function calculatePercent(row){
  if(row.renewed_status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') return 100;
  
  let score = 5; 
  if(hasVal(row.importer) || hasVal(row.manufacturer_source)) score = Math.max(score, 15);
  if(hasVal(row.result_phase1)) score = Math.max(score, 35);
  if(hasVal(row.analysis_result)) score = Math.max(score, 60);
  if(hasVal(row.plan_trial)) score = Math.max(score, 75);
  if(hasVal(row.result_phase3)) score = Math.max(score, 90);

  return score;
}

function hasVal(val){ return val && String(val).trim().length > 0 && String(val).trim() !== '-'; }
function safeText(txt){ return (txt && String(txt).trim()!=='') ? String(txt).trim() : '<span style="color:#b91c1c;font-weight:400">(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)</span>'; }

function renderTable(){
  const filter = $('stageFilter').value;
  const tbody = $('mainTbody');
  
  let activeRows = globalRows.filter(r => {
      const st = (r.renewed_status||'').trim();
      return st !== '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' && st !== '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà';
  });

  const filtered = activeRows.filter(r => {
    const pct = calculatePercent(r);
    if(filter === 'all') return true;
    if(filter === 'step1') return pct >= 5 && pct < 35;
    if(filter === 'step2') return pct >= 35 && pct < 60;
    if(filter === 'step3') return pct >= 60 && pct < 75;
    if(filter === 'step4') return pct >= 75 && pct < 90;
    if(filter === 'step5') return pct >= 90;
    return false;
  });

  $('countFiltered').textContent = filtered.length;

  if(filtered.length === 0){
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:40px;color:#94a3b8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(r => {
    const pct = calculatePercent(r);
    let stepName = '‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠';
    
    if(pct >= 90) stepName = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏ü‡∏™ 3 (‡∏£‡∏≠‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)';
    else if(pct >= 75) stepName = '‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (75%)';
    else if(pct >= 60) stepName = '‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡πâ‡∏ß';
    else if(pct >= 35) stepName = '‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ü‡∏™ 1 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';

    return `
    <tr>
      <td style="font-weight:700; color:#0f172a; font-size:15px">${safeText(r.trade_name)}</td>
      <td style="color:#334155">${safeText(r.common_name)}</td>
      <td>
        <div><span class="badge-step">${stepName}</span><span class="badge-pct">${pct}%</span></div>
        <div class="mini-progress-track"><div class="mini-progress-fill" style="width:${pct}%"></div></div>
      </td>
      <td style="color:#64748b;font-size:13px">${r.note || '-'}</td>
    </tr>`;
  }).join('');
}

function renderHistory(){
  const historyRows = globalRows.filter(r => {
      const st = (r.renewed_status||'').trim();
      return st === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' || st === '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà';
  });

  if(historyRows.length === 0){
    $('historyArea').textContent = '- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô -';
    return;
  }

  $('historyArea').innerHTML = historyRows.map(r => {
      const isDone = (r.renewed_status||'').trim() === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß';
      const icon = isDone ? '‚úÖ' : '‚ÑπÔ∏è';
      return `<div style="padding:4px 0; border-bottom:1px dashed #e2e8f0;">
         ${icon} <strong>${safeText(r.trade_name)}</strong> (${safeText(r.common_name)}) ‚Äî ${r.renewed_status}
      </div>`;
  }).join('');
}
</script>
</body>
</html>
