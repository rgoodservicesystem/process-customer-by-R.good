<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Customer Dashboard ‚Äî ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f8fafc;--card:#fff;--text:#334155;--accent:#0ea5a5;--success:#10b981;--warn:#f59e0b;--info:#3b82f6}
  *{box-sizing:border-box}
  body{font-family:"Prompt",sans-serif;background:var(--bg);margin:0;color:var(--text);padding-bottom:40px}
  
  header{background:#fff;padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10}
  .brand{font-weight:700;font-size:18px;color:#0f172a}
  .nav-link{text-decoration:none;color:#64748b;font-size:14px;margin-left:16px;padding:6px 12px;border-radius:6px;transition:0.2s}
  .nav-link:hover, .nav-link.active{background:#f1f5f9;color:#0f172a}

  .wrap{max-width:1000px;margin:24px auto;padding:0 20px}
  
  .search-box{background:#fff;padding:20px;border-radius:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);margin-bottom:24px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input{padding:12px;border:1px solid #cbd5e1;border-radius:10px;font-size:15px;outline:none;flex:1}
  button{padding:12px 20px;background:var(--text);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:0.2s}
  
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:24px}
  .stat-card{background:#fff;padding:20px;border-radius:16px;box-shadow:0 2px 4px rgba(0,0,0,0.04);border:1px solid #e2e8f0}
  .stat-label{font-size:13px;color:#64748b;margin-bottom:8px}
  .stat-val{font-size:32px;font-weight:700;line-height:1}
  .c-total{color:#0f172a} .c-done{color:var(--success)} .c-process{color:var(--warn)} .c-change{color:var(--info)}

  .progress-wrap{background:#e2e8f0;height:12px;border-radius:99px;overflow:hidden;display:flex;margin-bottom:24px}
  .p-bar{height:100%;transition:width 0.5s ease}

  .section-title{font-size:18px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
  .list-card{background:#fff;border-radius:16px;border:1px solid #e2e8f0;overflow:hidden}
  table{width:100%;border-collapse:collapse; min-width: 600px;}
  .table-responsive { overflow-x: auto; }
  
  th,td{padding:14px;text-align:left;border-bottom:1px solid #f1f5f9; vertical-align:middle;}
  th{background:#f8fafc;font-size:13px;color:#64748b;font-weight:600}
  tr:last-child td{border-bottom:none}
  .badge{padding:4px 10px;border-radius:99px;font-size:12px;font-weight:600;display:inline-block}
  .bg-done{background:#ecfdf5;color:#065f46} .bg-process{background:#fffbeb;color:#92400e}

  .mini-progress-track { width: 100%; background: #e2e8f0; height: 10px; border-radius: 6px; overflow: hidden; margin-top: 6px; }
  .mini-progress-fill { height: 100%; background: linear-gradient(90deg, #f59e0b, #fbbf24); border-radius: 6px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

  @media(max-width:600px){ .stats-grid{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>

<header>
  <div class="brand">Customer Dashboard</div>
  <nav>
    <a href="customer.html" class="nav-link">üìù ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
    <a href="#" class="nav-link active">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</a>
  </nav>
</header>

<div class="wrap">
  <div class="search-box">
    <label style="font-weight:600;white-space:nowrap">‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</label>
    <input id="access_code" placeholder="‡πÄ‡∏ä‡πà‡∏ô TEST999">
    <button id="btnLoad">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </div>

  <div id="contentArea" style="display:none">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div class="stat-val c-total" id="valTotal">0</div>
      </div>
      <div class="stat-card" style="background:#f0fdf4;border-color:#bbf7d0">
        <div class="stat-label">‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</div>
        <div class="stat-val c-done" id="valDone">0</div>
      </div>
      <div class="stat-card" style="background:#fffbeb;border-color:#fde68a">
        <div class="stat-label">‚è≥ ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
        <div class="stat-val c-process" id="valProcess">0</div>
      </div>
      <div class="stat-card" style="background:#ecfeff;border-color:#a5f3fc">
        <div class="stat-label">‚ÑπÔ∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï</div>
        <div class="stat-val c-change" id="valChange">0</div>
      </div>
    </div>

    <div class="section-title">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</div>
    <div class="progress-wrap">
      <div id="barDone" class="p-bar" style="background:var(--success);width:0%"></div>
      <div id="barProcess" class="p-bar" style="background:var(--warn);width:0%"></div>
      <div id="barChange" class="p-bar" style="background:var(--info);width:0%"></div>
    </div>

    <div style="margin-top:32px">
      <div class="section-title">
        <span>üî• ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)</span>
        <span class="badge bg-process" id="countProcessList">0</span>
      </div>
      <div class="list-card table-responsive">
        <table>
          <thead>
            <tr>
              <th style="min-width:160px">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
              <th style="min-width:140px">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç</th>
              <th style="min-width:180px">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
              <th style="min-width:120px">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            </tr>
          </thead>
          <tbody id="processTbody">
            <tr><td colspan="4" style="text-align:center;color:#94a3b8">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div style="margin-top:32px">
      <div class="section-title">
        <span>‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
      </div>
      <div class="list-card table-responsive">
        <table>
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr>
          </thead>
          <tbody id="doneTbody">
            <tr><td colspan="3" style="text-align:center;color:#94a3b8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
const SUPABASE_URL = 'https://vyfjqpwmvjborjrrtpne.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5ZmpxcHdtdmpib3JqcnJ0cG5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMTI4NjcsImV4cCI6MjA3OTg4ODg2N30.pu9ItBYuuQbH53lJmUzPCU2MW67RvCHr2rzhk3UQUw4';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = id => document.getElementById(id);

window.addEventListener('DOMContentLoaded', ()=>{
  const savedCode = localStorage.getItem('customer_access_code') || '';
  if(savedCode){ $('access_code').value = savedCode; loadDashboard(savedCode); }
});

$('btnLoad').addEventListener('click', ()=> loadDashboard($('access_code').value));
$('access_code').addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadDashboard($('access_code').value); });

async function loadDashboard(code){
  code = code.trim(); if(!code) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
  localStorage.setItem('customer_access_code', code);
  $('btnLoad').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
  
  try{
    const { data, error } = await sb.from('product_regs').select('*').eq('company_code', code);
    if(error) throw error;
    if(!data || data.length===0) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ');
    renderStats(data);
    $('contentArea').style.display = 'block';
  }catch(e){ console.error(e); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message); }
  finally{ $('btnLoad').textContent = '‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; }
}

function calculatePercent(row){
  if(row.renewed_status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') return 100;
  let score = 5;
  if(hasVal(row.importer) || hasVal(row.manufacturer_source)) score = Math.max(score, 15);
  if(hasVal(row.result_phase1)) score = Math.max(score, 35);
  if(hasVal(row.analysis_result) || hasVal(row.plan_trial)) score = Math.max(score, 60);
  if(hasVal(row.result_phase3)) score = Math.max(score, 85);
  return score;
}

function hasVal(val){ return val && String(val).trim().length > 0 && String(val).trim() !== '-'; }

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
function safeText(txt){
  if(!txt || String(txt).trim() === '') return '<span style="color:#b91c1c;font-style:italic">(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)</span>';
  return String(txt).trim();
}

function renderStats(rows){
  let done=0, process=0, change=0, total=rows.length;
  const processList = []; const doneList = [];

  rows.forEach(r => {
    const st = (r.renewed_status || '').trim();
    if(st === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß'){ done++; doneList.push(r); }
    else if(st === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'){ process++; processList.push(r); }
    else if(st === '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà'){ change++; }
    else {
      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏Å‡πá‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô process ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      if(st !== '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') { process++; processList.push(r); }
    }
  });

  $('valTotal').textContent = total; 
  $('valDone').textContent = done;
  $('valProcess').textContent = process; 
  $('valChange').textContent = change;
  $('barDone').style.width = (total ? (done/total*100) : 0) + '%';
  $('barProcess').style.width = (total ? (process/total*100) : 0) + '%';
  $('barChange').style.width = (total ? (change/total*100) : 0) + '%';

  // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (‡πÉ‡∏ä‡πâ safeText ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠)
  $('countProcessList').textContent = process;
  const tbP = $('processTbody');
  if(processList.length){
    tbP.innerHTML = processList.map(r => {
      const pct = calculatePercent(r);
      let stepText = '‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á';
      if(pct >= 85) stepText = '‡∏£‡∏≠‡πÄ‡∏ü‡∏™ 3';
      else if(pct >= 60) stepText = '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå/‡∏ó‡∏î‡∏•‡∏≠‡∏á';
      else if(pct >= 35) stepText = '‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ü‡∏™ 1';

      return `
      <tr>
        <td style="font-weight:700; color:#000000; font-size:15px">
           ${safeText(r.trade_name)}
        </td>
        <td style="color:#000000">
           ${safeText(r.common_name)}
        </td>
        <td>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <span style="font-size:11px;font-weight:700;color:#64748b">${stepText}</span>
            <span style="font-size:12px;font-weight:700;color:#f59e0b">${pct}%</span>
          </div>
          <div class="mini-progress-track">
            <div class="mini-progress-fill" style="width:${pct}%"></div>
          </div>
        </td>
        <td style="color:#334155;font-size:13px">${r.note || '-'}</td>
      </tr>`;
    }).join('');
  } else {
    tbP.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:24px;color:#94a3b8">‚ú® ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</td></tr>`;
  }

  // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
  const tbD = $('doneTbody');
  if(doneList.length){
    doneList.sort((a,b)=> b.id - a.id);
    tbD.innerHTML = doneList.slice(0,5).map(r => `
      <tr>
        <td style="font-weight:700; color:#000000">${safeText(r.trade_name)}</td>
        <td>${safeText(r.common_name)}</td>
        <td><span class="badge bg-done">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</span></td>
      </tr>
    `).join('');
  } else {
    tbD.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:20px;color:#94a3b8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</td></tr>`;
  }
}
</script>
</body>
</html>
