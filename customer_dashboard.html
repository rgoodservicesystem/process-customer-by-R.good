<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Customer Portal ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f6fbff;--card:#fff;--mut:#64748b;--border:#e6eef5;--accent:#0ea5a5;--accent2:#60a5fa}
  *{box-sizing:border-box}
  body{font-family:"Prompt",sans-serif;background:var(--bg);margin:0;color:#0f172a}
  
  header{padding:12px 20px;background:linear-gradient(180deg,#f0fbff,#eaf7ff);border-bottom:1px solid var(--border)}
  
  .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 8px 28px rgba(10,30,60,.04)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{padding:10px;border-radius:10px;border:1px solid var(--border);font-size:14px;background:#fff}
  .btn{cursor:pointer; transition:0.2s}
  .btn:hover{opacity:0.9}
  .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;font-weight:700}
  .btn-ghost{background:#fff;border:1px solid #d6eef3;color:#0b6b6b}
  
  .btn-link{text-decoration:none; display:inline-flex; align-items:center; gap:6px; font-size:14px; font-weight:600; color:#0f172a; padding:8px 16px; border-radius:8px; background:#fff; border:1px solid #cbd5e1;}
  .btn-link:hover{background:#f1f5f9; color:#0ea5a5; border-color:#0ea5a5;}

  .small{font-size:13px;color:var(--mut)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  th{background:linear-gradient(180deg,#f7fbff,#f2f8ff);position:sticky;top:0;z-index:1; white-space:nowrap;}
  
  .table-responsive { overflow-x: auto; }
  
  .search{flex:1;min-width:220px}
  .muted{color:var(--mut);font-size:13px}
  .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; white-space:nowrap;}
  .b-done { background: #d1fae5; color: #065f46; border:1px solid #a7f3d0;}
  .b-process { background: #ffedd5; color: #9a3412; border:1px solid #fed7aa;}
  .b-change { background: #cffafe; color: #155e75; border:1px solid #a5f3fc;}
/* ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÜ */
.b-renew { 
    background: #fdf2f8; 
    color: #db2777; 
    border: 1px solid #fbcfe8;
    box-shadow: 0 2px 4px rgba(219, 39, 119, 0.05);
}

/* ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Ç‡∏∂‡πâ‡∏ô */
.status-badge {
    padding: 5px 10px;
    border-radius: 20px; /* ‡∏ó‡∏£‡∏á‡∏°‡∏ô‡∏™‡∏ß‡∏¢‡πÜ */
    font-size: 12px;
    font-weight: 700;
}
</style>
</head>
<body>

<header>
  <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
    <div style="font-weight:700;font-size:18px;margin-right:auto">Customer Portal</div>
    <a href="customer_dashboard.html" class="btn-link">üìä ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</a>
    <div class="small muted" style="display:none; @media(min-width:600px){display:block}">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <label style="font-weight:600">‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</label>
      <input id="access_code" placeholder="‡πÄ‡∏ä‡πà‡∏ô RG-XXXX" style="min-width:200px">
      <button id="useCode" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <div style="width:1px;height:24px;background:#e6eef5;margin:0 8px"></div>
      <input id="q" class="search" placeholder="‡∏Å‡∏£‡∏≠‡∏á: ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç / ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤..." />
      <button id="refreshBtn" class="btn btn-ghost">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      <button id="exportBtn" class="btn btn-ghost">Export CSV</button>
    </div>
    <div class="small muted" style="margin-top:8px">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
  </div>

  <div class="card">
    <div class="table-responsive" style="max-height:68vh">
      <table aria-describedby="table-info">
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç</th>
            <th>‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</th>
            <th>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï</th>
            <th>‡∏ú‡∏•‡πÄ‡∏ü‡∏™1</th>
            <th>‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</th>
            <th>‡πÅ‡∏ú‡∏ô/‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á</th>
            <th>‡∏ú‡∏•‡πÄ‡∏ü‡∏™3</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="11" class="small muted">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</td></tr></tbody>
      </table>
    </div>
    <div id="table-info" class="small muted" style="margin-top:8px"></div>
  </div>
</div>

<script>
// CONFIG
const SUPABASE_URL = 'https://vyfjqpwmvjborjrrtpne.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5ZmpxcHdtdmpib3JqcnJ0cG5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMTI4NjcsImV4cCI6MjA3OTg4ODg2N30.pu9ItBYuuQbH53lJmUzPCU2MW67RvCHr2rzhk3UQUw4';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = id => document.getElementById(id);
let currentRows = [];

function init(){
  const savedCode = localStorage.getItem('customer_access_code') || '';
  if(savedCode){ $('access_code').value = savedCode; loadDashboard(savedCode); }
}

async function useAccessCode(inputCode){
  inputCode = inputCode.trim();
  if(!inputCode) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
  localStorage.setItem('customer_access_code', inputCode);
  $('tbody').innerHTML = `<tr><td colspan="11" class="small muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó...</td></tr>`;

  try{
    // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á" ‡∏Å‡πà‡∏≠‡∏ô ---
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡πà‡∏≤ inputCode ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö 'code' (‡∏£‡∏´‡∏±‡∏™‡∏£‡∏∞‡∏ö‡∏ö) ‡∏´‡∏£‡∏∑‡∏≠ 'plain_code' (‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏≠‡∏á) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const { data: companies, error: compError } = await sb
      .from('companies')
      .select('code, name')
      .or(`code.eq.${inputCode},plain_code.eq.${inputCode}`)
      .limit(1);

    if(compError) throw compError;

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ü‡∏•‡∏∏‡πä‡∏Ñ) ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    let targetCode = inputCode;
    let companyName = '';

    if(companies && companies.length > 0){
        targetCode = companies[0].code; // ‡πÑ‡∏î‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (FK)
        companyName = companies[0].name || '';
        console.log(`Found Company: ${companyName} (${targetCode})`);
    } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á companies ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
        // ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô product_regs ‡∏ï‡∏£‡∏á‡πÜ ‡∏î‡∏π ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
        console.warn('Company not found, trying direct search...');
    }

    // --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á (targetCode) ---
    $('tbody').innerHTML = `<tr><td colspan="11" class="small muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</td></tr>`;
    
    const { data, error } = await sb
      .from('product_regs')
      .select('trade_name,common_name,importer,manufacturer_source,result_phase1,analysis_result,plan_trial,result_phase3,note,renewed_status')
      .eq('company_code', targetCode)
      .order('id');

    if(error) throw error;
    
    if(!data || data.length === 0){
      $('tbody').innerHTML = `<tr><td colspan="11" class="small muted" style="color:#b91c1c">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ "${inputCode}"</td></tr>`;
      $('table-info').textContent = '‡∏û‡∏ö 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
      currentRows = [];
      return;
    }

    currentRows = data;
    renderTable(currentRows);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠
    if(companyName) $('table-info').innerHTML = `<strong>${escapeHtml(companyName)}</strong> ‚Äî ‡∏û‡∏ö ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

  }catch(e){
    console.error(e);
    $('tbody').innerHTML = `<tr><td colspan="11" class="small muted" style="color:red">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e.message}</td></tr>`;
  }
}

function renderTable(rows){
  const tb = $('tbody');
  const q = ($('q').value||'').trim().toLowerCase();
  
  const filtered = q ? rows.filter(r => 
    [r.trade_name,r.common_name,r.importer,r.manufacturer_source,r.note].join(' ').toLowerCase().includes(q)
  ) : rows;

  if(!filtered.length){
    tb.innerHTML = `<tr><td colspan="11" class="small muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>`;
    $('table-info').textContent = '';
    return;
  }

  tb.innerHTML = filtered.map((r,i)=> {
    let badge = '-';
    const st = (r.renewed_status || '').trim();
    const phase1Val = (r.result_phase1 || '').trim();

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏µ
    if (st === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') {
        badge = '<span class="status-badge b-done">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>';
    } else if (st === '‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏') {
        badge = '<span class="status-badge b-renew">‚ôªÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</span>';
    } else if (st === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
        badge = '<span class="status-badge b-process">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
    } else if (st === '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà') {
        badge = '<span class="status-badge b-change">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà</span>';
    } else if (st) {
        badge = `<span class="small">${escapeHtml(st)}</span>`;
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• "-" ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏à‡∏≤‡∏á‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    const formatValue = (val) => {
        if (val === '-') return '<span style="color:#cbd5e1">-</span>'; // ‡∏Ç‡∏µ‡∏î‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏à‡∏≤‡∏á‡πÜ
        return escapeHtml(val);
    };

    return `
    <tr>
      <td>${i+1}</td>
      <td style="font-weight:600;color:#0ea5a5">${escapeHtml(r.trade_name)}</td>
      <td>${escapeHtml(r.common_name)}</td>
      <td style="color:#2563eb">${escapeHtml(r.importer)}</td>
      <td>${escapeHtml(r.manufacturer_source)}</td>
      <td style="text-align:center">${formatValue(r.result_phase1)}</td>
      <td>${formatValue(r.analysis_result)}</td>
      <td>${formatValue(r.plan_trial)}</td>
      <td>${formatValue(r.result_phase3)}</td>
      <td style="color:#64748b; font-size:12px">${escapeHtml(r.note)}</td>
      <td>${badge}</td>
    </tr>`;
  }).join('');
  
  if(!$('table-info').innerHTML.includes('<strong>')) {
     $('table-info').textContent = `‡πÅ‡∏™‡∏î‡∏á ${filtered.length} ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  }
}

function escapeHtml(s){ return String(s||'').replace(/[&<>'\"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[m]||m)); }

// EVENTS
$('useCode').addEventListener('click', ()=>{ useAccessCode($('access_code').value); });
$('access_code').addEventListener('keydown', (e)=>{ if(e.key==='Enter') useAccessCode($('access_code').value); });
$('refreshBtn').addEventListener('click', ()=>{ useAccessCode($('access_code').value); });
$('q').addEventListener('input', ()=>{ renderTable(currentRows); });

$('exportBtn').addEventListener('click', ()=>{
  if(!currentRows.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
  const rows = Array.from(document.querySelectorAll('#tbody tr')).map(tr => 
    Array.from(tr.children).map(td => td.textContent.replace(/\n/g,' ').trim())
  );
  const header = ['#','‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç','‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤','‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï','‡∏ú‡∏•‡πÄ‡∏ü‡∏™1','‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå','‡πÅ‡∏ú‡∏ô/‡∏ú‡∏•‡∏ó‡∏î‡∏•‡∏≠‡∏á','‡∏ú‡∏•‡πÄ‡∏ü‡∏™3','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
  const csvContent = [header, ...rows].map(e => e.map(c => `"${String(c).replace(/"/g, '""')}"`).join(",")).join("\n");
  const blob = new Blob(["\uFEFF"+csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `customer_export_${$('access_code').value}.csv`;
  link.click();
});

init();
</script>
</body>
</html>
